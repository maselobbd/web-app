name: Create and upload API, SWA and DB releases

on:
  workflow_dispatch:
    inputs:
      apiRunId:
        description: 'Enter API build workflow run ID: '
        required: true
      swaRunId:
        description: 'Enter SWA build workflow run ID: '
        required: true

jobs:
  prepare_release:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y.%m.%d.%H)
          RELEASE_NAME=Release-$DATE
          gh release create "$RELEASE_NAME" --repo ${{ vars.REPO }}

  upload_api_release_asset:
    runs-on: ubuntu-latest
    name: Create and upload API release asset
    needs: prepare_release
    steps:
      - name: Download api artifact
        id: daa
        uses: actions/download-artifact@v4
        with:
          name: artifact-API
          path: artifacts/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.inputs.apiRunId }}
  
      - name: Upload API release asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y.%m.%d.%H)
          RELEASE_NAME=Release-$DATE
          gh release upload "$RELEASE_NAME" artifacts/api_release.zip --repo ${{ vars.REPO }}

  upload_swa_release_asset:
    runs-on: ubuntu-latest
    name: Create and upload SWA release asset
    needs: 
      - prepare_release
    steps:
      - name: Download SWA artifact
        uses: actions/download-artifact@v4
        with:
          name: artifact-SWA
          path: artifacts/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.inputs.swaRunId }}

      - name: Upload SWA release asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y.%m.%d.%H)
          RELEASE_NAME=Release-$DATE
          gh release upload "$RELEASE_NAME" artifacts/swa_release.zip --repo ${{ vars.REPO }}

  upload_db_release_asset:
    runs-on: ubuntu-latest
    name: Create and upload DB release asset
    needs: 
      - prepare_release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Zip migration scripts
        run: zip db_migrations.zip db/migrations/ -r

      - name: Upload DB release asset
        id: create_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y.%m.%d.%H)
          RELEASE_NAME=Release-$DATE
          gh release upload "$RELEASE_NAME" db_migrations.zip --repo ${{ vars.REPO }}
